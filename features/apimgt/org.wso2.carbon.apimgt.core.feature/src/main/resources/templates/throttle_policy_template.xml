######## variables########
#set($newLine = "
")
#set($rule = "${policy.getPolicyLevel()}_${policy.getPolicyName()}")
#set($policyStream = "${policy.getPolicyLevel()}${policy.getPolicyName()}Stream")

########  macros  ########

#macro( getEligibilityQuery $policy )
	#if($policy.getPolicyLevel() == "api")

	FROM RequestStream
	SELECT '$rule' AS rule, messageID, ( not(api_key is null ) AND api_tier=='$policy.getPolicyName()' ) AS isEligible, str:concat('api_${policy.getPolicyName()}_', api_key,'_key') AS key, verb, ip
	INSERT INTO EligibilityStream;
	#elseif( $policy.getPolicyLevel() == "subscription" )
      ###other level stuff
    #else
      
    #end
	
#end

###generate condition using the pipeline object array
#macro( getPolicyCondition $policy )
ifThenElse(), 'condition0', 'elseCondition'#end

###generate execution plan for each condition
#macro( getConditions $policy )

##	#set($conditionCount = 0 ) 
##	#foreach( $conditionItem in $conditionlist )
##    FROM $policyStream[condition=='condition${conditionCount}']#window.time($conditionItem.getUnitTime() $conditionItem.getTimeUnit())
##    SELECT throttle_key, (count(messageID) >= $conditionItem.getRequestCount()) as isThrottled group by throttle_key 
##    INSERT ALL EVENTS into ResultStream;
##	#set($conditionCount = $conditionCount + 1 ) 
##	#end

####dummy####
	FROM $policyStream[condition=='condition0']#window.time(100 s)
	SELECT throttle_key, (count(messageID) >= 10000) as isThrottled group by throttle_key 
	INSERT ALL EVENTS into ResultStream;
#end

###generate else condition
#macro( getElseCondition $policy )
####fill the properties using parameters related to else condition
####dummy####

	FROM $policyStream[condition=='elseCondition']#window.time(1000 s)
	SELECT throttle_key, (count(messageID) >= 4000) as isThrottled group by throttle_key
   	INSERT ALL EVENTS into ResultStream;
#end


<policy tier="$policy.getPolicyName()" level="$policy.getPolicyLevel()" name="$rule">
	<eligibilityQuery>
#getEligibilityQuery($policy)
	</eligibilityQuery>
	<decisionQuery>
	
	FROM EligibilityStream[isEligible==true AND rule == '$rule'] 
	SELECT key as throttle_key, messageID, (#getPolicyCondition($policy)) as condition 
	INSERT into $policyStream;
	
	#getConditions($policy)
	
	#getElseCondition($policy)
	
	
	</decisionQuery>
</policy>

